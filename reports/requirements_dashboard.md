# 可視化ダッシュボード 要件定義書

## 1. プロジェクト概要

### 1.1 背景
MCP Orchestration Server は、複数のAIエージェントを調整する分散タスク管理システムです。現在、観測性機能（Prometheus メトリクス、構造化ロギング、トレーシング）が実装されていますが、これらのデータを視覚的に監視・分析する手段がありません。

### 1.2 目的
運用担当者および開発者が、システムの稼働状況、パフォーマンス、エラー発生状況をリアルタイムで把握し、迅速な問題解決と最適化を可能にするための可視化ダッシュボードを提供します。

### 1.3 スコープ

#### 対象範囲
- Prometheus メトリクスの可視化
- ログデータの検索・フィルタリング・表示
- タスクのトレース情報の可視化
- システム全体のヘルスステータス表示
- リアルタイム更新機能

#### 対象外
- アラート機能（将来的な拡張として検討）
- 自動スケーリング機能
- メトリクスの長期保存（Prometheusに委譲）

## 2. ステークホルダー

| 役割 | 説明 | 主な関心事 |
|------|------|-----------|
| システム運用者 | サーバーの日常的な監視・保守を担当 | システムの安定稼働、迅速な障害検知 |
| 開発者 | システムの開発・改善を担当 | パフォーマンス分析、デバッグ情報 |
| プロジェクトマネージャー | プロジェクト全体の進捗管理 | 全体のステータス、傾向分析 |

## 3. 機能要件

### 3.1 メトリクス可視化

#### 3.1.1 タスク関連メトリクス

**FR-M-001: タスク作成数の表示**
- 時系列グラフで `mcp_task_created_total` を表示
- 過去1時間、6時間、24時間、7日間の範囲を選択可能
- エージェントタイプ別の内訳を表示

**FR-M-002: タスク完了・失敗数の表示**
- `mcp_task_completed_total` と `mcp_task_failed_total` を同一グラフに表示
- 成功率（完了数 / (完了数 + 失敗数)）を計算して表示
- 時間範囲の選択機能

**FR-M-003: タスク処理時間の表示**
- `mcp_task_duration_seconds` のヒストグラムを表示
- P50、P95、P99 パーセンタイルを表示
- 平均処理時間の推移グラフ

**FR-M-004: アクティブエージェント数の表示**
- `mcp_active_agents` の現在値をゲージで表示
- 時系列での推移を折れ線グラフで表示
- エージェントタイプ別の内訳

#### 3.1.2 システムメトリクス

**FR-M-005: システムリソース表示**
- CPUとメモリ使用率（Node.js デフォルトメトリクス）
- イベントループ遅延
- アクティブハンドル数

### 3.2 ログ可視化

**FR-L-001: ログ一覧表示**
- 最新のログエントリを時系列で表示
- タイムスタンプ、ログレベル、メッセージ、コンテキストを表示
- ページネーションまたは仮想スクロール対応

**FR-L-002: ログフィルタリング**
- ログレベル（INFO、WARN、ERROR）でフィルタリング
- タイムレンジでフィルタリング
- フリーテキスト検索（メッセージ本文）
- `trace_id`、`task_id` による検索

**FR-L-003: ログ詳細表示**
- 個別のログエントリをクリックで詳細表示
- JSON形式の完全な構造を表示
- コンテキスト情報のハイライト表示

### 3.3 トレース可視化

**FR-T-001: タスクトレース表示**
- `trace_id` を指定してタスクの全ライフサイクルを表示
- タスク作成 → 割り当て → 実行 → 完了/失敗の流れを可視化
- 各ステップのタイムスタンプと所要時間を表示

**FR-T-002: トレースタイムライン**
- 複数のタスクを並行表示するタイムラインビュー
- 依存関係の可視化
- ボトルネックの特定支援

### 3.4 ダッシュボード全般

**FR-D-001: ホームダッシュボード**
- 主要メトリクスのサマリー表示
- システムヘルスステータス（正常/警告/エラー）
- 最近のエラーログ一覧

**FR-D-002: リアルタイム更新**
- メトリクスは5秒〜30秒間隔で自動更新（設定可能）
- ログは新規エントリを自動追加
- 手動リフレッシュ機能

**FR-D-003: レスポンシブデザイン**
- デスクトップ、タブレット、モバイルで適切に表示
- 1920x1080 および 1366x768 での最適化

## 4. 非機能要件

### 4.1 パフォーマンス

**NFR-P-001: ページロード時間**
- 初期ページロードは3秒以内
- ダッシュボード切り替えは1秒以内

**NFR-P-002: データ表示**
- 100,000件のログエントリまでスムーズに扱える
- グラフ描画は500ms以内

### 4.2 可用性

**NFR-A-001: サービス稼働率**
- ダッシュボードサービスは99%の可用性を目標
- Prometheusやログサーバーが停止してもダッシュボードは起動可能（エラー表示）

### 4.3 ユーザビリティ

**NFR-U-001: 直感的なUI**
- 初回利用でもマニュアルなしで基本操作が可能
- 一般的なダッシュボードUIパターンに準拠

**NFR-U-002: アクセシビリティ**
- WCAG 2.1 レベルAA準拠
- キーボード操作対応

### 4.4 セキュリティ

**NFR-S-001: 認証・認可**
- 基本認証またはトークンベース認証の実装
- 読み取り専用アクセスと管理者アクセスの区別

**NFR-S-002: データ保護**
- HTTPS通信の使用
- センシティブ情報のマスキング

### 4.5 保守性

**NFR-M-001: 拡張性**
- 新しいメトリクスやグラフの追加が容易
- プラグイン機能の検討

**NFR-M-002: テスタビリティ**
- ユニットテストカバレッジ80%以上
- E2Eテストの実装

## 5. ユーザーストーリー

### US-001: システム運用者がシステムの健全性を確認する
**As a** システム運用者  
**I want to** ダッシュボードでシステムの主要メトリクスを一目で確認したい  
**So that** 異常を早期に発見し、迅速に対応できる

**受け入れ基準:**
- ホームダッシュボードで全体のヘルスステータスが表示される
- エラー数、成功率、処理時間などの主要指標が表示される
- 異常値が視覚的に識別できる（色分け、アラート表示）

### US-002: 開発者が失敗したタスクをデバッグする
**As a** 開発者  
**I want to** 失敗したタスクのログとトレース情報を確認したい  
**So that** 問題の原因を特定し、修正できる

**受け入れ基準:**
- 失敗したタスクの一覧が表示される
- タスクの `trace_id` からすべての関連ログを検索できる
- タイムライン表示で処理の流れが把握できる

### US-003: 運用者がパフォーマンスの傾向を分析する
**As a** システム運用者  
**I want to** 過去のメトリクスデータをグラフで確認したい  
**So that** パフォーマンスの傾向を把握し、キャパシティプランニングができる

**受け入れ基準:**
- 過去24時間、7日間、30日間のデータを表示できる
- タスク処理量の推移が確認できる
- ピーク時間帯が特定できる

### US-004: 開発者が特定エージェントの動作を確認する
**As a** 開発者  
**I want to** 特定のエージェントタイプのメトリクスを個別に確認したい  
**So that** エージェント別のパフォーマンスを比較・分析できる

**受け入れ基準:**
- エージェントタイプでフィルタリングできる
- エージェント別の処理時間、成功率が比較できる
- 特定エージェントのログのみを表示できる

## 6. 制約条件

### 6.1 技術的制約
- メトリクスデータは既存の Prometheus エンドポイント（`http://localhost:9090/metrics`）から取得
- ログデータは `logs/combined.log` および `logs/error.log` から取得
- 既存のMCPサーバーに影響を与えない独立したサービスとして実装

### 6.2 運用制約
- 追加のインフラコストは最小限に抑える
- 既存のDocker環境で動作可能
- ローカル開発環境での動作を優先

### 6.3 時間的制約
- 初期バージョン（MVP）は2週間以内に完成
- フルバージョンは4週間以内

## 7. 成功基準

### 7.1 定量的基準
- ページロード時間 < 3秒
- メトリクス更新間隔 < 30秒
- ユーザビリティテストでのタスク成功率 > 90%

### 7.2 定性的基準
- 運用者が問題を5分以内に特定できる
- 開発者がデバッグ時間を50%削減できる
- ステークホルダーから肯定的なフィードバック

## 8. 今後の拡張

### フェーズ2（将来検討）
- アラート機能（閾値設定、通知）
- カスタムダッシュボード作成機能
- レポート生成機能（PDF出力）
- 複数サーバーの統合監視
- 機械学習による異常検知

## 9. 付録

### 9.1 参考システム
- Grafana: メトリクス可視化のベストプラクティス
- Kibana: ログ検索・分析のUI/UX
- Datadog: 統合監視ダッシュボード

### 9.2 関連ドキュメント
- [実装計画 - 観測性](file:///c:/Users/zeroz/Orchestrations/reports/implementation_plan_observability.md)
- [MCP Orchestration アーキテクチャ](file:///c:/Users/zeroz/Orchestrations/mcp-orchestration-architecture.md)
